---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getAllPosts, formatDate } from '../../lib/sanity';

const posts = await getAllPosts();

// Extract unique categories for filter buttons
const categories = [...new Set(posts.map((p: any) => p.category).filter(Boolean))];
---

<BaseLayout title="Blog — Yasen Lilov" activePage="blog">

  <!-- Blog Header -->
  <section class="hero" style="padding-bottom: 20px;">
    <div class="container">
      <h1 style="font-size: 2.25rem;">Blog</h1>
      <p style="color: var(--text-secondary); margin-top: 8px;">Thoughts on analytics, AI, and building MarTech systems.</p>
    </div>
  </section>

  <!-- Filters + Posts -->
  <section style="padding-top: 0; padding-bottom: 48px;">
    <div class="container">
      {categories.length > 0 && (
        <div class="blog-filters">
          <button class="filter-btn active" data-category="all">All</button>
          {categories.map((cat: string) => (
            <button class="filter-btn" data-category={cat}>{cat}</button>
          ))}
        </div>
      )}

      {posts.length > 0 ? (
        <div class="post-grid">
          {posts.map((post: any) => (
            <article class="post-card" data-category={post.category}>
              <div class="post-card-meta">
                <span class="post-card-category">{post.category}</span>
                <span>{formatDate(post.publishedAt)}</span>
              </div>
              <h3><a href={`/blog/${post.slug}`}>{post.title}</a></h3>
              <p>{post.excerpt}</p>
              {post.tags && post.tags.length > 0 && (
                <div class="post-card-tags">
                  {post.tags.map((tag: string) => (
                    <span class="tag">{tag}</span>
                  ))}
                </div>
              )}
            </article>
          ))}
        </div>
      ) : (
        <p style="color: var(--text-muted); text-align: center;">Posts coming soon — content migration in progress.</p>
      )}
    </div>
  </section>

</BaseLayout>

<script>
  // Client-side category filtering
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const category = btn.getAttribute('data-category');

      // Update active button
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      // Filter posts
      document.querySelectorAll('.post-card').forEach(card => {
        if (category === 'all' || card.getAttribute('data-category') === category) {
          (card as HTMLElement).style.display = '';
        } else {
          (card as HTMLElement).style.display = 'none';
        }
      });
    });
  });
</script>
